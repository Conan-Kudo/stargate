#!/usr/bin/env python3

import os
import signal
import subprocess
import sys

stargate_version = "stargate"

print("sys.argv == {}".format(sys.argv))

# When respawning, give the old process a chance to garbage collect first
if "--delay" in sys.argv:
    sys.argv.remove("--delay")
    import time
    time.sleep(2)

def start_stargate():
    from sglib.log import LOG
    from sgui.sgqt import QApplication, QGuiApplication, QtCore
    from sgui.util import setup_theme
    try:
        QGuiApplication.setAttribute(QtCore.Qt.AA_EnableHighDpiScaling)
        QGuiApplication.setHighDpiScaleFactorRoundingPolicy(
            QtCore.Qt.HighDpiScaleFactorRoundingPolicy.PassThrough,
        )
    except Exception as ex:
        LOG.warning(
            f"The platform you are using does not support Qt HiDpi: {ex}"
        )
    app = QApplication(sys.argv)
    scaler = setup_theme(app)
    from sgui.splash import SplashScreen
    splash_screen = SplashScreen(scaler.y_res)
    from sgui.main import main
    main(app, splash_screen, scaler)

# Run the engine
if len(sys.argv) > 1:
    def sig_handle(a_1=None, a_2=None):
        try:
            f_proc.kill()
        except Exception as ex:
            print("Exception while trying to kill engine from "
                "helper script: {}".format(ex))

    signal.signal(signal.SIGTERM, sig_handle)
    signal.signal(signal.SIGINT, sig_handle)
    signal.signal(signal.SIGABRT, sig_handle)

    engine_exe = f"{stargate_version}-engine"
    # local development
    f_path = os.path.join(
        os.path.dirname(__file__),
        "..",
        "engine",
        engine_exe
    )
    if not os.path.exists(f_path):
        # system
        print(
            "Could not detect local development engine, trying system engine"
        )
        f_path = os.path.join(
            os.path.dirname(__file__),
            engine_exe
        )
    f_path = os.path.abspath(f_path)
    print(f_path)
    f_proc = subprocess.Popen([f_path] + sys.argv[1:])
    f_proc.wait()
    print("helper script:  f_proc returned with {}".format(f_proc.returncode))
    sys.exit(f_proc.returncode)
else:  # Run the UI, which will run the engine
    f_prefix_dir = os.path.dirname(__file__)
    f_path = os.path.join(
        f_prefix_dir,
        "..",
    )
    f_path = os.path.abspath(f_path)
    print(f_path)
    sys.path.insert(0, f_path)
    try:
        start_stargate()
    except ImportError:
        print(
            "Did not detect local development environment, trying "
            "system installation",
        )
        f_path = os.path.join(
            f_prefix_dir,
            "..",
            "lib",
            stargate_version,
            "stargate",
        )
        f_path = os.path.abspath(f_path)
        print(f_path)
        sys.path.insert(0, f_path)
        start_stargate()
